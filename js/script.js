const fundos = [
    '../img/Alvorada.jpeg',
    '../img/Castelinho.jpeg',
    '../img/Fonte.jpeg',
    '../img/RecantoDaHarmonia.jpeg',
    '../img/PianoBar.jpeg',
];

console.log('üîç Script.js carregado');

function toggleSaloes() {
    console.log('üîÑ Fun√ß√£o toggleSaloes chamada');
    const saloesContainer = document.querySelector('.saloes');
    console.log('üì¶ Container de sal√µes encontrado:', saloesContainer ? 'Sim' : 'N√£o');
    saloesContainer.classList.toggle('minimized');
    console.log('‚úÖ Classe minimized alternada');
}

function toggleCarrossel(carrosselId) {
    console.log(`üîÑ Fun√ß√£o toggleCarrossel chamada para: ${carrosselId}`);
    const conteudo = document.querySelector(`[onclick="toggleCarrossel('${carrosselId}')"]`);
    console.log('üì¶ Elemento conte√∫do encontrado:', conteudo ? 'Sim' : 'N√£o');
    const carrossel = document.getElementById(carrosselId);
    console.log('üì¶ Elemento carrossel encontrado:', carrossel ? 'Sim' : 'N√£o');

    // Alterna a visibilidade do carrossel
    if (carrossel.style.display === "none" || !carrossel.style.display) {
        console.log('üìä Exibindo carrossel');
        carrossel.style.display = "block";
        conteudo.classList.add("expandido"); // Adiciona a classe expandido
        console.log('‚úÖ Classe expandido adicionada');
    } else {
        console.log('üìä Ocultando carrossel');
        carrossel.style.display = "none";
        conteudo.classList.remove("expandido"); // Remove a classe expandido
        console.log('‚úÖ Classe expandido removida');
    }
}

function moveCarrossel(id, direction) {
    console.log(`üîÑ Fun√ß√£o moveCarrossel chamada para: ${id}, dire√ß√£o: ${direction}`);
    const carrossel = document.getElementById(id);
    console.log('üì¶ Elemento carrossel encontrado:', carrossel ? 'Sim' : 'N√£o');
    
    if (!carrossel) {
        console.error(`‚ùå Carrossel com ID ${id} n√£o encontrado`);
        return;
    }
    
    const imagens = carrossel.querySelector('.carrossel-imagens');
    console.log('üì¶ Container de imagens encontrado:', imagens ? 'Sim' : 'N√£o');
    
    if (!imagens) {
        console.error(`‚ùå Container de imagens n√£o encontrado no carrossel ${id}`);
        return;
    }
    
    const imgs = imagens.querySelectorAll('img');
    console.log(`üìä Total de imagens encontradas: ${imgs.length}`);
    const totalImages = imgs.length;

    let currentIndex = parseInt(imagens.getAttribute('data-index')) || 0;
    console.log(`üìä √çndice atual: ${currentIndex}`);

    currentIndex += direction;
    console.log(`üìä Novo √≠ndice (antes da verifica√ß√£o): ${currentIndex}`);

    if (currentIndex >= totalImages) {
        currentIndex = 0;
        console.log('üîÑ √çndice ajustado para o in√≠cio');
    } else if (currentIndex < 0) {
        currentIndex = totalImages - 1;
        console.log('üîÑ √çndice ajustado para o final');
    }

    console.log(`üìä √çndice final: ${currentIndex}`);
    imagens.setAttribute('data-index', currentIndex);

    imgs.forEach(img => img.classList.remove('active'));
    imgs[currentIndex].classList.add('active');
    console.log(`‚úÖ Imagem ${currentIndex} ativada`);
}

setInterval(() => {
    console.log('‚è±Ô∏è Intervalo de carrossel executando');
    
    const carrossel1 = document.getElementById('carrossel1');
    if (carrossel1 && carrossel1.style.display === 'block') {
        console.log('üîÑ Movendo carrossel1');
        moveCarrossel('carrossel1', 1);
    }

    const carrossel2 = document.getElementById('carrossel2');
    if (carrossel2 && carrossel2.style.display === 'block') {
        console.log('üîÑ Movendo carrossel2');
        moveCarrossel('carrossel2', 1);
    }

    const carrossel3 = document.getElementById('carrossel3');
    if (carrossel3 && carrossel3.style.display === 'block') {
        console.log('üîÑ Movendo carrossel3');
        moveCarrossel('carrossel3', 1);
    }
}, 3000);

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOMContentLoaded - Configurando eventos');
    
    document.querySelectorAll('.conteudo').forEach(conteudo => {
        console.log('üì¶ Configurando evento para elemento conte√∫do');
        conteudo.addEventListener('click', () => {
            console.log('üñ±Ô∏è Conte√∫do clicado');
            const sessao = conteudo.closest('.sessao');
            console.log('üì¶ Sess√£o encontrada:', sessao ? 'Sim' : 'N√£o');
            sessao.classList.toggle('expandida');
            console.log('‚úÖ Classe expandida alternada');
        });
    });

    const menuToggle = document.getElementById('menu-toggle');
    console.log('üì¶ Bot√£o de menu encontrado:', menuToggle ? 'Sim' : 'N√£o');
    
    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            console.log('üñ±Ô∏è Bot√£o de menu clicado');
            const navLinks = document.getElementById('nav-links');
            console.log('üì¶ Nav links encontrados:', navLinks ? 'Sim' : 'N√£o');
            navLinks.classList.toggle('active');
            console.log('‚úÖ Classe active alternada');
        });
    }
    
    console.log('‚úÖ Eventos configurados com sucesso');
});

/*--------------------------------------------------*/

// Fun√ß√£o para abrir o popup
function openPopup(celula = null) {
    console.log('üîÑ Fun√ß√£o openPopup chamada');
    console.log('üì¶ C√©lula fornecida:', celula ? 'Sim' : 'N√£o');
    
    const popup = document.getElementById('visit-popup');
    console.log('üì¶ Popup encontrado:', popup ? 'Sim' : 'N√£o');
    
    if (celula) {
        console.log('üìä Processando dados da c√©lula');
        const nome = document.getElementById('popup-nome');
        const empresa = document.getElementById('popup-empresa');
        const data = document.getElementById('popup-data');
        const hora = document.getElementById('popup-hora');
        const locais = document.getElementById('popup-locais');
        
        // Preencher os dados da visita
        if (celula.classList.contains('visita')) {
            console.log('üìä C√©lula cont√©m classe visita, preenchendo dados');
            nome.textContent = celula.getAttribute('data-nome') || "N√£o informado";
            empresa.textContent = celula.getAttribute('data-empresa') || "N√£o informado";
            data.textContent = celula.getAttribute('data-data') || "N√£o informado";
            hora.textContent = celula.getAttribute('data-hora') || "N√£o informado";
            locais.textContent = celula.getAttribute('data-locais') || "N√£o informado";
            console.log('‚úÖ Dados preenchidos no popup');
        } else {
            console.log('‚ÑπÔ∏è C√©lula n√£o cont√©m classe visita');
        }
    }

    popup.style.display = 'flex';
    console.log('‚úÖ Popup exibido');
}

// Fun√ß√£o para fechar o popup
function closePopup() {
    console.log('üîÑ Fun√ß√£o closePopup chamada');
    const popup = document.getElementById('visit-popup');
    console.log('üì¶ Popup encontrado:', popup ? 'Sim' : 'N√£o');
    
    if (popup) {
        popup.style.display = 'none';
        console.log('‚úÖ Popup ocultado');
    } else {
        console.error('‚ùå Elemento popup n√£o encontrado');
    }
}

// Fun√ß√£o para cadastrar visita e marcar o calend√°rio
function cadastrarVisita(event) {
    console.log('üîÑ Fun√ß√£o cadastrarVisita chamada');
    event.preventDefault(); // Evitar envio do formul√°rio
    console.log('üõë Comportamento padr√£o do formul√°rio prevenido');

    const nome = document.getElementById('novo-nome').value;
    const empresa = document.getElementById('novo-empresa').value;
    const data = document.getElementById('novo-data').value;
    const hora = document.getElementById('novo-hora').value;
    const locais = document.getElementById('novo-locais').value;

    console.log('üìã Dados coletados:', { nome, empresa, data, hora, locais });

    if (!nome || !empresa || !data || !hora || !locais) {
        console.warn('‚ö†Ô∏è Campos obrigat√≥rios n√£o preenchidos');
        alert("Por favor, preencha todos os campos.");
        return;
    }

    // Ajustar para garantir que a data ser√° exatamente a fornecida pelo usu√°rio (sem considerar o fuso hor√°rio)
    console.log('üîÑ Processando data');
    const dataParts = data.split('-');  // Dividir a data no formato YYYY-MM-DD
    console.log('üìä Partes da data:', dataParts);
    const dataVisita = new Date(Date.UTC(dataParts[0], dataParts[1] - 1, dataParts[2]));  // Criar data com hora em UTC
    console.log('üìÖ Data da visita (UTC):', dataVisita);

    const dia = dataVisita.getUTCDate(); // Pega o dia (em UTC)
    const mes = dataVisita.getUTCMonth(); // Pega o m√™s (em UTC)
    console.log('üìä Dia:', dia, 'M√™s:', mes);

    // Marcar o dia no calend√°rio
    console.log('üîÑ Marcando dia no calend√°rio');
    const calendarioDivs = document.querySelectorAll('.calendar div');
    console.log(`üìä Total de divs no calend√°rio: ${calendarioDivs.length}`);
    
    let encontrado = false;
    calendarioDivs.forEach((div) => {
        if (div.textContent === dia.toString()) {
            console.log(`üìä Div do dia ${dia} encontrada`);
            div.classList.add('visita');
            div.setAttribute('data-nome', nome);
            div.setAttribute('data-empresa', empresa);
            div.setAttribute('data-data', data);
            div.setAttribute('data-hora', hora);
            div.setAttribute('data-locais', locais);
            encontrado = true;
            console.log('‚úÖ Atributos adicionados √† div');
        }
    });
    
    if (!encontrado) {
        console.warn(`‚ö†Ô∏è Div para o dia ${dia} n√£o encontrada no calend√°rio`);
    }

    // Limpar o formul√°rio ap√≥s o cadastro
    document.getElementById('register-visit-form').reset();
    console.log('‚úÖ Formul√°rio resetado');
    
    // Fechar o popup ap√≥s o cadastro
    closePopup();
    console.log('‚úÖ Cadastro conclu√≠do');
}

// Fun√ß√£o para abrir o popup quando um dia com visita for clicado
function openVisitPopup(event) {
    console.log('üîÑ Fun√ß√£o openVisitPopup chamada');
    const dia = event.target;
    console.log('üì¶ Elemento dia clicado:', dia);

    if (dia.classList.contains('visita')) {
        console.log('üìä Dia cont√©m classe visita, obtendo dados');
        // Pega as informa√ß√µes da visita associada ao dia
        const nome = dia.getAttribute('data-nome');
        const empresa = dia.getAttribute('data-empresa');
        const data = dia.getAttribute('data-data');
        const hora = dia.getAttribute('data-hora');
        const locais = dia.getAttribute('data-locais');
        const visitaId = dia.getAttribute('data-id');
        
        console.log('üìã Dados obtidos:', { nome, empresa, data, hora, locais, visitaId });

        // Verifica se os elementos do pop-up existem antes de definir os valores
        const popupNome = document.getElementById('popup-nome');
        const popupEmpresa = document.getElementById('popup-empresa');
        const popupData = document.getElementById('popup-data');
        const popupHora = document.getElementById('popup-hora');
        const popupLocais = document.getElementById('popup-locais');
        const btnIniciarVisita = document.getElementById('btn-iniciar-visita');
        
        console.log('üì¶ Elementos do popup encontrados:', 
            popupNome ? 'Nome: Sim' : 'Nome: N√£o',
            popupEmpresa ? 'Empresa: Sim' : 'Empresa: N√£o',
            popupData ? 'Data: Sim' : 'Data: N√£o',
            popupHora ? 'Hora: Sim' : 'Hora: N√£o',
            popupLocais ? 'Locais: Sim' : 'Locais: N√£o',
            btnIniciarVisita ? 'Bot√£o Iniciar: Sim' : 'Bot√£o Iniciar: N√£o'
        );

        if (popupNome && popupEmpresa && popupData && popupHora && popupLocais) {
            popupNome.textContent = nome || "N√£o informado";
            popupEmpresa.textContent = empresa || "N√£o informado";
            popupData.textContent = data || "N√£o informado";
            popupHora.textContent = hora || "N√£o informado";
            popupLocais.textContent = locais || "N√£o informado";
            console.log('‚úÖ Dados preenchidos no popup');

            // Verificar se a visita j√° foi finalizada
            if (visitaId) {
                verificarVisitaFinalizada(visitaId).then(finalizada => {
                    if (finalizada && btnIniciarVisita) {
                        // Se a visita j√° foi finalizada, mudar o bot√£o para "Relat√≥rio da Visita"
                        btnIniciarVisita.textContent = "Relat√≥rio da Visita";
                        btnIniciarVisita.onclick = function() {
                            window.location.href = `relatorio.html?id=${finalizada.id}`;
                        };
                        console.log('‚úÖ Bot√£o alterado para Relat√≥rio da Visita');
                    } else if (btnIniciarVisita) {
                        // Se a visita n√£o foi finalizada, manter o bot√£o como "Iniciar Visita"
                        btnIniciarVisita.textContent = "Iniciar Visita";
                        btnIniciarVisita.onclick = function() {
                            window.location.href = `visita.html?id=${visitaId}`;
                        };
                        console.log('‚úÖ Bot√£o configurado para Iniciar Visita');
                    }
                }).catch(error => {
                    console.error('‚ùå Erro ao verificar status da visita:', error);
                    // Em caso de erro, manter o bot√£o como "Iniciar Visita"
                    if (btnIniciarVisita) {
                        btnIniciarVisita.textContent = "Iniciar Visita";
                        btnIniciarVisita.onclick = function() {
                            window.location.href = `visita.html?id=${visitaId}`;
                        };
                    }
                });
            } else if (btnIniciarVisita) {
                // Se n√£o tiver ID da visita, esconder o bot√£o
                btnIniciarVisita.style.display = 'none';
                console.log('‚úÖ Bot√£o de iniciar visita ocultado');
            }

            // Exibe o pop-up
            const popup = document.getElementById('visit-popup');
            popup.style.display = 'block';
            console.log('‚úÖ Popup exibido');
        } else {
            console.error("‚ùå Elementos do pop-up n√£o encontrados no DOM.");
        }
    } else {
        console.log('‚ÑπÔ∏è Dia n√£o cont√©m classe visita');
        // Se o dia n√£o tiver visita, exibe uma mensagem de alerta
        alert("N√£o h√° visita registrada para este dia.");
    }
}

// Fun√ß√£o para verificar se uma visita j√° foi finalizada
async function verificarVisitaFinalizada(visitaId) {
    console.log(`üîÑ Verificando se a visita ${visitaId} j√° foi finalizada`);
    
    try {
        const response = await fetch(`http://localhost:3000/api/verificar-visita-finalizada/${visitaId}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                // Visita n√£o finalizada
                console.log(`‚ÑπÔ∏è Visita ${visitaId} n√£o foi finalizada`);
                return null;
            }
            throw new Error(`Erro na requisi√ß√£o: ${response.status}`);
        }
        
        const resultado = await response.json();
        console.log(`‚úÖ Visita ${visitaId} j√° foi finalizada:`, resultado);
        return resultado;
    } catch (error) {
        console.error(`‚ùå Erro ao verificar se a visita ${visitaId} foi finalizada:`, error);
        throw error;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOMContentLoaded - Configurando eventos do calend√°rio');
    
    // Adiciona o evento de clique ao calend√°rio para abrir o popup
    const calendarioDivs = document.querySelectorAll('.calendar div');
    console.log(`üìä Total de divs no calend√°rio: ${calendarioDivs.length}`);
    
    calendarioDivs.forEach((div) => {
        div.addEventListener('click', function(event) {
            console.log('üñ±Ô∏è Div do calend√°rio clicada:', div.textContent);
            openVisitPopup(event);
        });
    });
    
    console.log('‚úÖ Eventos do calend√°rio configurados');
});


let anoAtual = new Date().getFullYear();  // Ano atual
let mesAtual = new Date().getMonth();  // M√™s atual (0-11)
console.log('üìÖ Ano atual:', anoAtual, 'M√™s atual:', mesAtual);

// Fun√ß√£o para obter o nome do m√™s
function obterNomeMes(mes) {
    console.log('üîÑ Fun√ß√£o obterNomeMes chamada para m√™s:', mes);
    const nomesDosMeses = [
        "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
    ];
    const nomeMes = nomesDosMeses[mes];
    console.log('üìä Nome do m√™s:', nomeMes);
    return nomeMes;
}

// Fun√ß√£o para carregar visitas do banco
async function carregarVisitas() {
    console.log('üîÑ Fun√ß√£o carregarVisitas chamada');
    alert("Carregando visitas do banco...");
    try {
        console.log('üîÑ Iniciando requisi√ß√£o para obter visitas');
        const response = await fetch('http://localhost:3000/api/visitas'); // Substitua pela URL correta da API
        console.log('üìä Status da resposta:', response.status);
        
        if (!response.ok) {
            console.error('‚ùå Resposta n√£o ok:', response.status, response.statusText);
            throw new Error(`Erro na requisi√ß√£o: ${response.status} ${response.statusText}`);
        }
        
        const visitas = await response.json();
        console.log('üìã Visitas recebidas:', visitas);

        alert(`Visitas carregadas: ${JSON.stringify(visitas)}`);
        marcarVisitasNoCalendario(visitas);
        console.log('‚úÖ Visitas marcadas no calend√°rio');
    } catch (error) {
        console.error('‚ùå Erro ao carregar visitas:', error);
        alert("Erro ao carregar visitas: " + error.message);
    }
}

// Fun√ß√£o para gerar o calend√°rio
function gerarCalendario() {
    console.log('üîÑ Fun√ß√£o gerarCalendario chamada');
    alert("Gerando calend√°rio...");
    const diasDoMes = new Date(anoAtual, mesAtual + 1, 0).getDate(); // N√∫mero de dias no m√™s atual
    const primeiroDiaSemana = new Date(anoAtual, mesAtual, 1).getDay(); // Dia da semana do primeiro dia do m√™s
    console.log('üìä Dias no m√™s:', diasDoMes, 'Primeiro dia da semana:', primeiroDiaSemana);
    
    const calendarElement = document.getElementById('calendar');
    console.log('üì¶ Elemento calend√°rio encontrado:', calendarElement ? 'Sim' : 'N√£o');

    if (!calendarElement) {
        console.error('‚ùå Elemento calendar n√£o encontrado');
        alert("Elemento calendar n√£o encontrado!");
        return;
    }
    
    console.log('‚úÖ Calend√°rio gerado com sucesso');
}